let map={keys:[{id:1,color:"#888",stroke:"#3b3b3b",strokeWidth:.5,solid:!1},{id:2,color:"#555",stroke:"#3b3b3b",strokeWidth:.5,solid:!0,restitution:.15},{id:3,color:"#555",stroke:"#3b3b3b",strokeWidth:.5,solid:!0,restitution:.15},{id:4,color:"#3498db",solid:!0,foreground:!0},{id:5,color:"#f39c12",solid:!0,foreground:!0},{id:6,color:"#636e72",stroke:"#3b3b3b",strokeWidth:1,solid:!0,restitution:.15},{id:7,color:"#1abc9c",solid:!0,stroke:!0,restitution:.15}],levels:[[[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[3,6,6,6,6,6,6,1,1,1,1,1,1,1,1,1,1,1,6,6,6,6,6,6,3],[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]],[[2,2,2,2,2,2,2,2,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,2],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]],[[2,2,2,2,2,2,2,2,2,2,2,6,6,6,6,6,6,6,6,2,2,2,2,2,2],[3,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,7,1,1,1,1,3],[3,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,7,1,1,1,1,3],[3,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,7,1,1,1,1,3],[3,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,7,1,1,1,1,3],[3,1,1,6,6,6,1,1,6,6,6,1,1,1,1,1,1,1,1,6,6,6,6,6,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]],[[2,2,6,6,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],[3,6,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,3],[3,6,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,3],[3,6,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,3],[3,6,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,3],[3,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,6,6,3],[3,1,1,1,1,1,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[3,1,1,1,1,1,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,6,6,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,3],[6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,6,6,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,1,3],[6,1,1,1,1,1,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,1,1,3],[6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]]],complete_1:!1,complete_2:!1,complete_3:!1,complete_4:!1,tile_size:16};class UIcontrols{constructor(){this.portal_gun=new Audio("https://raw.githubusercontent.com/nickshillingford/nickshillingford.github.io/master/sounds/portal_gun.mp3"),this.portal_gun.type="audio/mpeg",this.switch_portal=new Audio("https://raw.githubusercontent.com/nickshillingford/nickshillingford.github.io/master/sounds/portal_switch.mp3"),this.switch_portal.type="audio/mpeg",this.jump_sound=new Audio("https://raw.githubusercontent.com/nickshillingford/nickshillingford.github.io/master/sounds/jump.mp3"),this.jump_sound.type="audio/mpeg",this.orange_indicator=document.querySelector("#orange"),this.orange_indicator.style.opacity=.2,this.blue_indicator=document.querySelector("#blue"),this.blue_indicator.style.opacity=1,this.shot_once=!1,this.jump_switch=0,this.mode=!0,this.pr=!1,this.pl=!1,this.pd=!1,this.pu=!1,this.key={left:!1,right:!1,up:!1,pr:!1,pl:!1,pd:!1,pu:!1}}keyDown(e){switch(e.keyCode){case 37:this.key.left=!0;break;case 38:this.key.up=!0;try{this.jump_sound.play()}catch(e){console.log(e)}break;case 39:this.key.right=!0;break;case 68:this.key.pr=!0;try{this.portal_gun.play()}catch(e){console.log(e)}break;case 65:this.key.pl=!0;try{this.portal_gun.play()}catch(e){console.log(e)}break;case 83:this.key.pd=!0;try{this.portal_gun.play()}catch(e){console.log(e)}break;case 87:this.key.pu=!0;try{this.portal_gun.play()}catch(e){console.log(e)}break;case 13:this.switchPortals();try{this.switch_portal.play()}catch(e){console.log(e)}}}keyUp(e){switch(e.keyCode){case 37:this.key.left=!1;break;case 38:this.key.up=!1;break;case 39:this.key.right=!1;break;case 68:this.key.pr=!1,this.shot_once=!1;break;case 65:this.key.pl=!1,this.shot_once=!1;break;case 83:this.key.pd=!1,this.shot_once=!1;break;case 87:this.key.pu=!1,this.shot_once=!1}}switchPortals(){this.pr||this.pl||this.pd||this.pu?console.log("switching not available while a portal is in the air."):(this.mode=!this.mode,this.mode?(this.orange_indicator.style.opacity=.2,this.blue_indicator.style.opacity=1):(this.blue_indicator.style.opacity=.2,this.orange_indicator.style.opacity=1))}}class Engine{constructor(){this.laser_sound=new Audio("https://raw.githubusercontent.com/nickshillingford/nickshillingford.github.io/master/sounds/laser.mp3"),this.bodies=[companion,player,turrent_1,turrent_2],this.resolver=new Resolver,this.gp=new UIcontrols,this.force_field=!1,this.switch_point=500,this.count=0,this.gravity={x:0,y:.3},this.vel_limit={x:2,y:9},this.portal_vel_limit={x:24,y:24},window.onkeydown=this.gp.keyDown.bind(this.gp),window.onkeyup=this.gp.keyUp.bind(this.gp)}loadMap(e,t,i,o,l,s){this.current_map=e,this.current_level=this.current_map.levels[t],this.setResolver(e);var a=this;this.current_map.width=0,this.current_map.height=0,e.keys.forEach(function(e){a.current_level.forEach(function(t,i){a.current_map.height=Math.max(a.current_map.height,i),t.forEach(function(t,o){a.current_map.width=Math.max(a.current_map.width,o),t==e.id&&(a.current_level[i][o]=e)})})}),this.current_map.width_p=this.current_map.width*e.tile_size,this.current_map.height_p=this.current_map.height*e.tile_size,e.complete_1&&e.complete_2&&e.complete_3&&(turrent_1.location.x=8*e.tile_size,turrent_1.location.y=7*e.tile_size,turrent_2.location.x=7*e.tile_size,turrent_2.location.y=15*e.tile_size),companion.location.x=l*e.tile_size,companion.location.y=s*e.tile_size,player.location.x=i*e.tile_size,player.location.y=o*e.tile_size}setResolver(e){this.resolver.portal_vel_limit=this.portal_vel_limit,this.resolver.current_level=this.current_level,this.resolver.laser_fired=this.laser_fired,this.resolver.vel_limit=this.vel_limit,this.resolver.gravity=this.gravity,this.resolver.bodies=this.bodies,this.resolver.gp=this.gp}drawTile(e,t,i,o){o.fillStyle=i.color,i.stroke?(o.strokeStyle=i.stroke,o.lineWidth=i.strokeWidth,o.beginPath(),o.rect(e,t,map.tile_size,map.tile_size),o.fill(),o.stroke()):o.fillRect(e,t,map.tile_size,map.tile_size)}drawMap(e,t){for(var i=0;i<this.current_level.length;i++)for(var o=0;o<this.current_level[i].length;o++)if(!t&&!this.current_level[i][o].foreground||t&&this.current_level[i][o].foreground){var l=o*map.tile_size,s=i*map.tile_size;this.drawTile(l,s,this.current_level[i][o],e)}if(map.complete_1&&map.complete_2&&!map.complete_3)this.forceField();else if(map.complete_3){23==Math.round(this.bodies[3].location.y/map.tile_size)&&this.openFloor()}}update(e){this.gp.key.left&&player.velocity.x>-this.vel_limit.x&&(player.velocity.x-=player.movement_speed.left),this.gp.key.up&&player.can_jump&&player.velocity.y>-this.vel_limit.y&&(player.velocity.y-=player.movement_speed.jump,player.can_jump=!1),this.gp.key.right&&player.velocity.x<this.vel_limit.x&&(player.velocity.x+=player.movement_speed.left);var t=this.gp.mode?blue:orange;if(!this.gp.key.pr&&!this.gp.key.pl||this.gp.shotOnce||this.gp.pl||this.gp.pr||this.gp.pd||this.gp.pu||(this.gp.key.pr?(t.location.x=player.location.x+4,this.gp.pr=!0):(t.location.x=player.location.x-4,this.gp.pl=!0),t.location.y=player.location.y+4,this.gp.shot_once=!0),!this.gp.key.pd&&!this.gp.key.pu||this.gp.shotOnce||this.gp.pl||this.gp.pr||this.gp.pd||this.gp.pu||(this.gp.key.pd?this.gp.pd=!0:this.gp.pu=!0,t.location.x=player.location.x,t.location.y=player.location.y,this.gp.shot_once=!0),map.complete_1&&map.complete_2&&map.complete_3){for(var i=2;i<this.bodies.length;i++){var o=Math.round(player.location.x/map.tile_size),l=Math.round(player.location.y/map.tile_size),s=(Math.round(this.bodies[i].location.x/map.tile_size),Math.round(this.bodies[i].location.y/map.tile_size));if(o<18&&s<23&&l==s&&!laser.fired){laser.location.x=this.bodies[i].location.x+7,laser.location.y=this.bodies[i].location.y+7,laser.horizontal=!0,laser.fired=!0;try{this.laser_sound.play()}catch(e){console.log(e)}}}laser.fired&&this.resolver.resolveLaser()}(this.gp.pr||this.gp.pl)&&this.resolver.resolvePortal(0),(this.gp.pd||this.gp.pu)&&this.resolver.resolvePortal(1),this.resolver.resolveBodies()}redirect(e){if(blue.open&&orange.open){var t,i=this.calculateOverlap();0!=i.overlap_orange_1||0!=i.overlap_orange_2?t=[blue.pos.x,blue.pos.y]:0==i.overlap_blue_1&&0==i.overlap_blue_2||(t=[orange.pos.x,orange.pos.y]),player.location.x>390?t[0]>0&&24==t[1]?(player.velocity.y=-player.velocity.x,player.location.x=t[0]*map.tile_size,player.location.y=(t[1]-1)*map.tile_size):24==t[0]&&t[1]>0?(player.velocity.x=-player.velocity.x,player.location.x=(t[0]-.6)*map.tile_size,player.location.y=t[1]*map.tile_size):(player.location.x=t[0]*map.tile_size,player.location.y=t[1]*map.tile_size):player.location.x<0?t[0]>0&&24==t[1]?(player.velocity.y=player.velocity.x,player.location.x=t[0]*map.tile_size,player.location.y=(t[1]-1)*map.tile_size):0==t[0]&&t[1]>0?(player.velocity.x=-player.velocity.x,player.location.x=(t[0]+.6)*map.tile_size,player.location.y=t[1]*map.tile_size):(player.location.x=t[0]*map.tile_size,player.location.y=t[1]*map.tile_size):player.location.y>390&&(t[0]>0&&24==t[1]?(player.velocity.y=-player.velocity.y,player.location.x=t[0]*map.tile_size,player.location.y=t[1]*map.tile_size):24==t[0]&&t[1]>0?(player.velocity.x=-player.velocity.y,player.location.x=t[0]*map.tile_size,player.location.y=t[1]*map.tile_size):0==t[0]&&t[1]>0?(player.velocity.x=player.velocity.y,player.location.x=t[0]*map.tile_size,player.location.y=t[1]*map.tile_size):(player.location.x=t[0]*map.tile_size,player.location.y=t[1]*map.tile_size))}}drawBodies(e){let t=map.complete_3?4:2;for(var i=0;i<t;i++)e.fillStyle=this.bodies[i].color,e.strokeStyle=this.bodies[i].stroke,e.lineWidth=this.bodies[i].lineWidth,e.beginPath(),e.rect(this.bodies[i].location.x,this.bodies[i].location.y,map.tile_size,map.tile_size),e.fill(),e.stroke()}drawLaser(e){e.fillStyle=laser.color,e.beginPath(),e.arc(laser.location.x,laser.location.y,map.tile_size/2-4,0,2*Math.PI),e.fill(),laser.horizontal?(laser.velocity.x<this.vel_limit.x&&(laser.velocity.x+=laser.speed),laser.backwards?laser.location.x-=laser.velocity.x:laser.location.x+=laser.velocity.x):(laser.velocity.y<6&&(laser.velocity.y+=laser.speed-1),laser.location.y-=laser.velocity.y)}drawPortal(e,t){var i=this.gp.mode?map.keys[3].color:map.keys[4].color,o=this.gp.mode?blue:orange;switch(e.fillStyle=i,e.beginPath(),e.arc(o.location.x,o.location.y,map.tile_size/2-4,0,2*Math.PI),e.fill(),68==t||65==t?o.velocity.x<this.vel_limit.x&&(o.velocity.x+=o.speed):o.velocity.y<this.vel_limit.y&&(o.velocity.y+=o.speed),t){case 68:o.location.x+=o.velocity.x;break;case 65:o.location.x-=o.velocity.x;break;case 83:o.location.y+=o.velocity.y;break;case 87:o.location.y-=o.velocity.y}}draw(e){this.drawMap(e,!1),this.drawBodies(e),this.redirect(e),map.complete_1&&map.complete_2&&map.complete_3&&laser.fired&&this.drawLaser(e),this.gp.pr&&this.drawPortal(e,68),this.gp.pl&&this.drawPortal(e,65),this.gp.pd&&this.drawPortal(e,83),this.gp.pu&&this.drawPortal(e,87),this.drawMap(e,!0)}forceField(){if(this.count==this.switch_point){this.force_field=!this.force_field,this.switch_point=this.switch_point+500;var e=this.force_field?map.keys[6]:map.keys[5];this.current_level[1][19]=e,this.current_level[2][19]=e,this.current_level[3][19]=e,this.current_level[4][19]=e}this.count++}openFloor(){this.current_level[5][2]=map.keys[0],this.current_level[5][3]=map.keys[0]}calculateOverlap(){let e=Math.max(0,Math.min(player.bbox.right,orange.bbox.right_1)-Math.max(player.bbox.left,orange.bbox.left_1)),t=Math.max(0,Math.min(player.bbox.bottom,orange.bbox.bottom_1)-Math.max(player.bbox.top,orange.bbox.top_1)),i=Math.max(0,Math.min(player.bbox.right,orange.bbox.right_2)-Math.max(player.bbox.left,orange.bbox.left_2)),o=Math.max(0,Math.min(player.bbox.bottom,orange.bbox.bottom_2)-Math.max(player.bbox.top,orange.bbox.top_2));return{overlap_orange_1:e*t,overlap_blue_1:Math.max(0,Math.min(player.bbox.right,blue.bbox.right_1)-Math.max(player.bbox.left,blue.bbox.left_1))*Math.max(0,Math.min(player.bbox.bottom,blue.bbox.bottom_1)-Math.max(player.bbox.top,blue.bbox.top_1)),overlap_orange_2:i*o,overlap_blue_2:Math.max(0,Math.min(player.bbox.right,blue.bbox.right_2)-Math.max(player.bbox.left,blue.bbox.left_2))*Math.max(0,Math.min(player.bbox.bottom,blue.bbox.bottom_2)-Math.max(player.bbox.top,blue.bbox.top_2))}}}class Resolver{resolveBodies(){let e=map.complete_3?4:2;for(var t=0;t<e;t++){var i=this.bodies[t].location.x+this.bodies[t].velocity.x,o=this.bodies[t].location.y+this.bodies[t].velocity.y,l=Math.round(map.tile_size/2-1),s=Math.round(this.bodies[t].location.x/map.tile_size),a=Math.round(this.bodies[t].location.y/map.tile_size),r=this.getTile(s,a);1==t&&(player.bbox.top=Math.round(player.location.y),player.bbox.left=Math.round(player.location.x),player.bbox.right=player.bbox.left+map.tile_size,player.bbox.bottom=player.bbox.top+map.tile_size,r.jump&&this.gp.jump_switch>15?(player.can_jump=!0,this.gp.jump_switch=0):this.gp.jump_switch++),this.bodies[t].velocity.x+=this.gravity.x,this.bodies[t].velocity.y+=this.gravity.y;var p=Math.round((this.bodies[t].location.y-l)/map.tile_size),h=Math.round((this.bodies[t].location.y+l)/map.tile_size),n=Math.round((this.bodies[t].location.x-l)/map.tile_size),c=Math.round((this.bodies[t].location.x+l)/map.tile_size),y=Math.floor(o/map.tile_size),_=Math.ceil(o/map.tile_size),b=Math.floor(i/map.tile_size),d=Math.ceil(i/map.tile_size),m=this.getTile(n,y),u=this.getTile(c,y),g=this.getTile(n,_),x=this.getTile(c,_),v=this.getTile(b,p),k=this.getTile(b,h),f=this.getTile(d,p),z=this.getTile(d,h);if(this.bodies[t].velocity.x=Math.min(Math.max(this.bodies[t].velocity.x,-this.portal_vel_limit.x),this.portal_vel_limit.x),this.bodies[t].velocity.y=Math.min(Math.max(this.bodies[t].velocity.y,-this.portal_vel_limit.y),this.portal_vel_limit.y),this.bodies[t].location.x+=this.bodies[t].velocity.x,this.bodies[t].location.y+=this.bodies[t].velocity.y,this.bodies[t].velocity.x*=.9,v.solid||k.solid||f.solid||z.solid){for(;this.getTile(Math.floor(this.bodies[t].location.x/map.tile_size),p).solid||this.getTile(Math.floor(this.bodies[t].location.x/map.tile_size),h).solid;)this.bodies[t].location.x+=.1;for(;this.getTile(Math.ceil(this.bodies[t].location.x/map.tile_size),p).solid||this.getTile(Math.ceil(this.bodies[t].location.x/map.tile_size),h).solid;)this.bodies[t].location.x-=.1;var M=0;v.solid&&v.restitution>M&&(M=v.restitution),k.solid&&k.restitution>M&&(M=k.restitution),f.solid&&f.restitution>M&&(M=f.restitution),z.solid&&z.restitution>M&&(M=z.restitution),this.bodies[t].velocity.x*=-M||0}if(m.solid||u.solid||g.solid||x.solid){for(;this.getTile(n,Math.floor(this.bodies[t].location.y/map.tile_size)).solid||this.getTile(c,Math.floor(this.bodies[t].location.y/map.tile_size)).solid;)this.bodies[t].location.y+=.1;for(;this.getTile(n,Math.ceil(this.bodies[t].location.y/map.tile_size)).solid||this.getTile(c,Math.ceil(this.bodies[t].location.y/map.tile_size)).solid;)this.bodies[t].location.y-=.1;M=0;m.solid&&m.restitution>M&&(M=m.restitution),u.solid&&u.restitution>M&&(M=u.restitution),g.solid&&g.restitution>M&&(M=g.restitution),x.solid&&x.restitution>M&&(M=x.restitution),this.bodies[t].velocity.y*=-M||0,1==t&&(!g.solid&&!x.solid||r.jump||(player.can_jump=!0))}}this.check()}resolvePortal(e){var t,i,o;this.gp.mode?(t=Math.round(blue.location.x/map.tile_size),i=Math.round(blue.location.y/map.tile_size)):(t=Math.round(orange.location.x/map.tile_size),i=Math.round(orange.location.y/map.tile_size));var l=this.getTile(t,i);if(4==(o=0==e?this.current_level[i-1][t].id:this.current_level[i][t-1].id)||5==o)this.destroyPortal();else if(l.solid&&7!=l.id)if(4==l.id||5==l.id||6==l.id)this.destroyPortal();else{var s,a=this.gp.mode?map.keys[3]:map.keys[4];this.gp.mode?(this.resetTiles(4),blue.pos.y=i,blue.pos.x=t):(this.resetTiles(5),orange.pos.y=i,orange.pos.x=t),0==e?(this.current_level[i-1][t]=a,s={x:t,y:i-1},blue.open&&orange.open&&(this.current_level[i-1][t].solid=!1),this.gp.pr?this.gp.pr=!1:this.gp.pl&&(this.gp.pl=!1)):(this.current_level[i][t+1].id,this.current_level[i][t-1]=a,s={x:t-1,y:i},blue.open&&orange.open&&(this.current_level[i][t-1].solid=!1),this.gp.pd?this.gp.pd=!1:this.gp.pu&&(this.gp.pu=!1)),this.gp.mode?(blue.bbox.top_1=Math.round(i*map.tile_size),blue.bbox.left_1=Math.round(t*map.tile_size),blue.bbox.right_1=blue.bbox.left_1+map.tile_size,blue.bbox.bottom_1=blue.bbox.top_1+map.tile_size,blue.bbox.top_2=Math.round(s.y*map.tile_size),blue.bbox.left_2=Math.round(s.x*map.tile_size),blue.bbox.right_2=blue.bbox.left_2+map.tile_size,blue.bbox.bottom_2=blue.bbox.top_2+map.tile_size,blue.open=!0):(orange.bbox.top_1=Math.round(i*map.tile_size),orange.bbox.left_1=Math.round(t*map.tile_size),orange.bbox.right_1=orange.bbox.left_1+map.tile_size,orange.bbox.bottom_1=orange.bbox.top_1+map.tile_size,orange.bbox.top_2=Math.round(s.y*map.tile_size),orange.bbox.left_2=Math.round(s.x*map.tile_size),orange.bbox.right_2=orange.bbox.left_2+map.tile_size,orange.bbox.bottom_2=orange.bbox.top_2+map.tile_size,orange.open=!0),this.current_level[i][t]=a,a.solid=!0,blue.open&&orange.open&&(this.current_level[i][t].solid=!1,this.gp.mode?this.current_level[orange.pos.y][orange.pos.x].solid=!1:this.current_level[blue.pos.y][blue.pos.x].solid=!1)}else 4!=l.id&&5!=l.id||this.destroyPortal()}resolveLaser(){var e=Math.round(laser.location.x/map.tile_size),t=Math.round(laser.location.y/map.tile_size),i=Math.round(player.location.x/map.tile_size),o=Math.round(player.location.y/map.tile_size),l=this.getTile(e,t);4!=l.id&&5!=l.id||!blue.open||!orange.open||laser.backwards||(laser.backwards=!0,laser.location.x=4==l.id?orange.location.x:blue.location.x,laser.location.y=4==l.id?orange.location.y+3:blue.location.y+3),24==Math.round(laser.location.y/map.tile_size)&&(laser.horizontal=!1),e==i&&t==o&&(laser.horizontal?laser.backwards?(player.velocity.x-=player.knock_back,player.velocity.x*=.9):(player.velocity.x+=player.knock_back,player.velocity.x*=.9):(player.velocity.y+=-player.knock_back,player.velocity.y*=.9),laser.backwards=!1,laser.fired=!1);for(var s=2;s<this.bodies.length;s++){var a=Math.round(this.bodies[s].location.x/map.tile_size),r=Math.round(this.bodies[s].location.y/map.tile_size);e==a&&t==r&&laser.backwards&&(this.bodies[s].velocity.x-=this.bodies[s].knock_back,this.bodies[s].velocity.x*=.9,laser.backwards=!1,laser.fired=!1)}(e>24||6==l.id&&e<22||6==l.id&&!laser.horizontal)&&(laser.horizontal=!0,laser.backwards=!1,laser.fired=!1)}resetTiles(e){for(var t=0;t<this.current_level[0].length;t++)this.current_level[0][t].id==e&&(this.current_level[0][t]=map.keys[1]);for(t=0;t<this.current_level.length;t++)this.current_level[t][0].id==e&&(this.current_level[t][0]=map.keys[1]);for(t=0;t<this.current_level.length;t++)this.current_level[t][this.current_level.length-1].id==e&&(this.current_level[t][this.current_level.length-1]=map.keys[1]);for(t=0;t<this.current_level[0].length;t++)this.current_level[this.current_level.length-1][t].id==e&&(this.current_level[this.current_level.length-1][t]=map.keys[1])}destroyPortal(){this.gp.pr=!1,this.gp.pl=!1,this.gp.pd=!1,this.gp.pu=!1}companion(){var e=Math.round(companion.location.x/map.tile_size),t=Math.round(companion.location.y/map.tile_size),i=Math.round(player.location.x/map.tile_size),o=Math.round(player.location.y/map.tile_size),l=!1;return e==i&&t==o&&(l=!0),l}check(){var e=this.companion();e&&!map.complete_1?map.complete_1=!0:e&&!map.complete_2?map.complete_2=!0:e&&!map.complete_3?map.complete_3=!0:e&&!map.complete_4&&(map.complete_4=!0)}getTile(e,t){return this.current_level[t]&&this.current_level[t][e]?this.current_level[t][e]:0}}let player={location:{x:0,y:0},velocity:{x:0,y:0},bbox:{top:0,left:0,right:0,bottom:0},movement_speed:{left:.2,right:.2,jump:6},knock_back:8.75,color:"#ecf0f1",stroke:"#555",lineWidth:1.5,can_jump:!0},companion={location:{x:0,y:0},velocity:{x:0,y:0},color:"#f8a5c2",stroke:"#555",lineWidth:1},orange={open:!1,pos:{x:0,y:0},location:{x:0,y:0},velocity:{x:0,y:0},bbox:{top_1:0,left_1:0,right_1:0,bottom_1:0,top_2:0,left_2:0,right_2:0,bottom_2:0},speed:5},blue={open:!1,pos:{x:0,y:0},location:{x:0,y:0},velocity:{x:0,y:0},bbox:{top_1:0,left_1:0,right_1:0,bottom_1:0,top_2:0,left_2:0,right_2:0,bottom_2:0},speed:5},turrent_1={location:{x:0,y:0},velocity:{x:0,y:0},knock_back:4.2,color:"#4b4b4b",stroke:"#4b4b4b",lineWidth:0},turrent_2={location:{x:0,y:0},velocity:{x:0,y:0},knock_back:4.2,color:"#4b4b4b",stroke:"#4b4b4b",lineWidth:0},laser={location:{x:0,y:0},velocity:{x:0,y:0},color:"#fc2847",horizontal:!0,backwards:!1,fired:!1,speed:3.5};
